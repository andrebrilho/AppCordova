<!DOCTYPE html>
<html ng-app="app">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Crefisa</title>
    <link rel="stylesheet" href="webfiles/css/tema.css" media="all" type="text/css" />
    <link href="styles/loadmask.css" rel="stylesheet" type="text/css">
    <link href="webfiles/css/fase2.css" rel="stylesheet" />
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/jquery.js"></script>
    <script type="text/javascript" src="scripts/jqueryui.js"></script>
    <script src="scripts/storage-help.js"></script>
    <script src="scripts/util/Util.js"></script>
    <script src="scripts/angular.min.js" type="text/javascript"></script>
    <script src="scripts/jquery.loadmask.js"></script>
    <script type="text/javascript" language="javascript" src="webfiles/plugins/tether/dist/js/tether.min.js" charset="UTF-8"></script>
    <script type="text/javascript" language="javascript" src="webfiles/js/bootstrap.min.js" charset="UTF-8"></script>
    <script type="text/javascript" language="javascript" src="webfiles/js/custom.js" charset="UTF-8"></script>
    <script src="scripts/module.js"></script>
    <script src="scripts/services.js" type="text/javascript"></script>
    <script src="scripts/emprestimoValor-controller.js" type="text/javascript"></script>
    <script src="webfiles/js/jquery.mask.min.js"></script>
    <script src="scripts/PreCadastroLocalStorage.js"></script>
</head>
<body>
    <nav class="app-nav" style="display: none;">
        <div class="breadcrumb-nav">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12">
                        <a href="javascript:void(0);" title="Voltar" class="app-nav-collapse icone pull-xs-left"><img src="webfiles/images/icones/close.svg" /></a>
                        <div class="text-xs-center">Menu</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="msg-container nome-cliente">

        </div>

        <div id="dvMenu"></div>
    </nav>
    <section class="app-container">
        <div class="breadcrumb-nav">
            <div class="container">
                <div class="row">
                    <div class="col-xs-2">
                        <a href="pagina-pre-cadastro.html" title="Voltar" class="icone"><i class="fa fa-angle-left"></i></a>
                    </div>
                    <div class="col-xs-10" style="margin-left:15%; font-size:18px">
                        Dados de Patrimônio
                    </div>
                </div>
            </div>
        </div>
    </section>
    <style>
        .badge-ok {
            border-radius: 3px;
            width: 20px;
            height: 20px;
            color: white;
            font-size: 12px;
            padding-top: 3px;
            position: absolute;
            top: 21px;
            right: 35px;
            background: #60b28a;
            text-align: center;
        }

        .badge-wrng {
            border-radius: 3px;
            width: 20px;
            height: 20px;
            color: #244b6d;
            font-size: 12px;
            padding-top: 3px;
            position: absolute;
            top: 21px;
            right: 35px;
            background: #ffcc5c;
            text-align: center;
        }

        .pre-cadastro-bg-numbers {
            height: 60px;
            width: 60px;
            background: #c6ccce;
            font-size: 30px;
            font-family: Raleway;
            color: #485e6b;
            text-align: center;
            padding-top: 10px;
        }

        .pre-cadastro-textdiv {
            width: calc(100%-60px);
        }

        .pre-cadastro-listitem {
            height: 62px;
            background: transparent;
            width: 100%;
            border-bottom: 2px solid #dee0e1;
            position: relative;
            z-index: 1;
        }

        .pre-cadastro-seta {
            position: absolute;
            right: 15px;
            top: 25px;
            color: #bababa;
        }

        .form-Fase2 {
            color: #485e6b;
        }
    </style>
    <section class="section app-container" id="content" style="color:#313131">

        <div id="Header" style="background-color:#244b6d;padding:20px 20px 15px 20px;position:relative;z-index:10">
            <h6 style="color: white; font-size:18px">Preencha os campos abaixo:</h6>
        </div>
        <div id="content" class="form-Fase2">

            <div class="container">

                <form class="formulario form-comum m-t-1" method="post" id="formPatrimonio">
                    <div class="row">
                        <div class="col-xs-12 m-b-1">
                            <p style="font-size:18px; font-weight:bold; padding-top:15px; text-align:left">Informar abaixo o seu tipo de Patrimônio (bens) e o valor aproximado.</p>
                        </div>
                        <div class="col-xs-12 m-b-1">
                            <label style="font-size:22px; font-weight:bold">Patrimônio:</label>
                            <select class="form-control" id="cboPatrimonio" name="TipoPatrimonio" style="padding: 0.5rem 0.75rem;font-size:22px;height:45px;background:#f5f5f5"></select>
                        </div>
                        <div class="col-xs-12 m-b-1" id="divValor">
                            <label style="font-size:24px; font-weight:bold">Valor do Patrimônio:</label>
                            <div class="row">
                                <div class="col-xs-2 m-b-1">
                                    <label class="pull-xs-left" style="font-size:22px; color:#485e6b; margin-top:10px; margin-left:12px">R$</label>
                                </div>
                                <div class="col-xs-10 m-b-1">
                                    <input type="text" id="txtValorPatrimonio" class="form-control" name="ValorPatrimonio" placeholder="Valor" style="background-color:#f5f5f5; color:#000000;font-size:22px" />
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <button type="submit" title="Continuar" class="btn btn-cor-primaria center-block m-t-2" style="font-size:18px;font-weight:bold">Continuar</button>
                        </div>
                        <div class="col-xs-12">
                            <a href="pagina-pre-cadastro-pessoal.html" title="Voltar" class="center-block btn btn-primary m-t-1" style="padding: 8px;">Voltar</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <section class="barra-acesso" style="clear:both">
        <div class="container">
            <div class="texto">
                <p class="nome m-h-20 fsize-1 text-xs-center m-b-0">
                    <b style='color:#969696'>Acesso: NOME DO CLIENTE - 000000000 / 12:00 - 15/02/2017</b>
                </p>

            </div>
        </div>
    </section>

    <div class="modal-aviso modal modal-simples modal-vertical fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="faltaPoucoLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="faltaPoucoLabel">Atenção</h4>
                </div>
                <div class="modal-body">
                    <p class="results"> </p>
                    <a href="#" title="Entendi" onclick="$('.modal-aviso').modal('hide')" class="btn btn-cor-primaria m-t-2">Entendi</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        var u = new Util();
        var sh1 = new StorageHelp();
        var user = JSON.parse(sh1.Login_Get());

        $(document).ready(function () {
        
            var combo_patrimonio;

            $("#txtValorPatrimonio").mask("000.000.000,00", { reverse: true });

            $("#txtValorPatrimonio").blur(function () {
                if ($("#cboPatrimonio").val() != "" && $("#txtValorPatrimonio").val() != "") {
                    var tipo = "";
                    var valor_minimo = 0;

                    tipo = $("#cboPatrimonio option:selected").html();
                    valor_minimo = parseFloat($("#cboPatrimonio option:selected").data("valor_min"));

                    var valor_digitado = parseFloat(("" + $("#txtValorPatrimonio").val()).replace(/[.]/g, "").replace(",", "."));

                    if (valor_digitado < valor_minimo) {
                        $("#Modal").modal("show");
                        $("#Modal .results").html("<p>Valor mínimo para <b>" + tipo + "</b> é de: <b>R$" + formatarReal(valor_minimo) + "</b></p>");
                        $("#txtValorPatrimonio").val("");
                    }
                }
            });

            var localStorage = new PreCadastroLocalStorage("patrimonio_" + user.id_user);

            $('#content').loadmask("");

            jQuery.support.cors = true;
            $.ajaxSetup({ cache: false });
            var request = $.ajax({
                url: u.GetUrlApi() + 'PreCadastro/GetDadosPatrimonio?NumCPF=' + user.id_user + "&plataforma=" + u.getPlatform() + "&versao=" + u.getVersion()
                    , method: 'POST'
                     , crossDomain: true
                    , dataType: "json"
                    , timeout: u.GetRequestTimeout()
                    , beforeSend: function (request) {
                        request.setRequestHeader("Authorization", 'Bearer ' + user.token);
                    }
            });

            request.done(function (_data) {

                var data = _data.DadosSolicitacaoPratrimoniais[0];
                if (data == undefined) {
                    data = {};
                }

                if (data.hasOwnProperty("Sequencial") && data.Sequencial > 0) {
                    if (data.hasOwnProperty('TipoPatrimonio') && data.TipoPatrimonio > 0) {
                        carregaPatrimonios(function () {
                            $("#cboPatrimonio").val(data.TipoPatrimonio);
                            if ($("#cboPatrimonio").val() == 7) {
                                $("#divValor").hide();
                                $("#txtValorPatrimonio").val("").prop("disabled", "disabled");
                            } else {
                                $("#divValor").show();
                                $("#txtValorPatrimonio").prop("disabled", false);
                            }
                        });
                    }
                    if (data.hasOwnProperty('ValorPatrimonio') && data.ValorPatrimonio > 0) {
                        var valor = data.ValorPatrimonio + "";
                        if (valor.indexOf(".") == -1) {
                            valor = valor + ".00";
                        }
                        $("#txtValorPatrimonio").val(formatarReal(("" + valor).replace(/[.]/g, "")));
                    }
                } else {
                    localStorage.inicializaCampos();
                    var precadastro = JSON.parse(sh1.PreCadastro_Get());
                    if (precadastro != null && precadastro.hasOwnProperty("TipoPatrimonio_patrimonio_" + user.id_user)) {
                        carregaPatrimonios(function () {
                            if (precadastro.hasOwnProperty("TipoPatrimonio_patrimonio_" + user.id_user)) {
                                $("#cboPatrimonio").val(precadastro["TipoPatrimonio_patrimonio_" + user.id_user].value); if ($("#cboPatrimonio").val() == 7) {
                                    $("#divValor").hide();
                                    $("#txtValorPatrimonio").val("").prop("disabled", "disabled");
                                } else {
                                    $("#divValor").show();
                                    $("#txtValorPatrimonio").prop("disabled", false);
                                }
                            }
                        });
                    } else {
                        carregaPatrimonios(function () { var localStorage = new PreCadastroLocalStorage("patrimonio" + "_" + user.id_user); localStorage.inicializaCampos() });
                    }
                }


                $("#cboPatrimonio").change(function () {
                    if ($("#cboPatrimonio").val() == 7) {
                        $("#divValor").hide();
                        $("#txtValorPatrimonio").val("").prop("disabled", "disabled");
                    } else {
                        $("#divValor").show();
                        $("#txtValorPatrimonio").prop("disabled", false);
                    }
                });

                $('#content').unloadmask("");
            });

            request.fail(function (data) {
                $('#content').unloadmask("");
                $("#Modal").modal("show");
                $("#Modal .results").html("Ocorreu um erro ao salvar os dados.");
            });

            $('#formPatrimonio').submit(function (e) {
                e.preventDefault();

                $("#Modal .results").html("");
                var valido = true;

                if ($("#cboPatrimonio").val() == "") {
                    $("#Modal .results").append("Informe o patrimônio.<br/>");
                    valido = false;
                }

                if ($("#txtValorPatrimonio").val() == "" && $("#cboPatrimonio").val() != 7) {
                    $("#Modal .results").append("Preencha o valor do patrimônio.<br/>");
                    valido = false;
                }

                if (valido) {
                    var serializeArray = $("#formPatrimonio").serializeArray();

                    var obj = {};

                    for (var i = 0; i < serializeArray.length; i++) {
                        obj[serializeArray[i]['name']] = serializeArray[i]['value'];
                    }

                    obj["CPF"] = user.id_user;

                    if (obj.TipoPatrimonio == 7) {
                        obj.ValorPatrimonio = 1;
                    }

                    if (obj.hasOwnProperty("ValorPatrimonio") && (obj.ValorPatrimonio != null || obj.ValorPatrimonio != ""))
                        obj.ValorPatrimonio = ("" + obj.ValorPatrimonio).replace(/[.]/g, "").replace(",", ".");

                    var request = $.ajax({
                        url: u.GetUrlApi() + "PreCadastro/SaveDadosPatrimonio?plataforma=" + u.getPlatform() + "&versao=" + u.getVersion()
                        , method: 'POST'
                         , crossDomain: true
                        , dataType: "json"
                        , timeout: u.GetRequestTimeout()
                        , beforeSend: function (request) {
                            request.setRequestHeader("Authorization", 'Bearer ' + user.token);
                        }
                        , data: obj

                    });
                    request.done(function (data) {
                        if (data.Error.length == 0) {
                            location.href = 'pagina-pre-cadastro-profissional.html';
                        } else {
                            $(".modal-aviso-retornoLogin").modal("show");
                            $(".modal-aviso-retornoLogin .results").html("Ocorreu um erro ao salvar os dados.");
                        }
                    });
                    request.fail(function (data) {
                        $('#content').unloadmask("");
                        $("#Modal").modal("show");
                        $("#Modal .results").html("Ocorreu um erro ao salvar os dados.");
                    });
                } else {
                    $("#Modal").modal("show");
                }
            });
        });

        function carregaPatrimonios(callback) {
            var requestPatrimonios = $.ajax({
                url: u.GetUrlApi() + 'PreCadastro/GetTipoPatrimonio?NumCPF=' + user.id_user + "&plataforma=" + u.getPlatform() + "&versao=" + u.getVersion()
                  , method: 'POST'
                   , crossDomain: true
                  , dataType: "json"
                  , timeout: u.GetRequestTimeout()
                  , beforeSend: function (request) {
                      request.setRequestHeader("Authorization", 'Bearer ' + user.token);
                  }
            });
            requestPatrimonios.done(function (data) {
                $("#cboPatrimonio").html("<option value=''>Selecione</option>");
                $.each(data.TipoPatrimonios, function (index, item) {
                    $("#cboPatrimonio").append("<option data-valor_min='" + item.ValorMinimo + "' value='" + item.CodigoTipoPatrimonio + "'>" + item.TipoPatrimonio + "</option>");
                });

                if (typeof callback === 'function') {
                    callback();
                }
            });
            requestPatrimonios.fail(function (data) { console.dir("erro ao carregar patrimonio"); });
        }

        function formatarReal(valor) {
            var temp = valor + '';
            temp = temp.replace(/\D/g, '');
            temp = temp.replace(/(\d)(\d{11})$/, "$1.$2");
            temp = temp.replace(/(\d)(\d{8})$/, "$1.$2");
            temp = temp.replace(/(\d)(\d{5})$/, "$1.$2");
            temp = temp.replace(/(\d)(\d{2})$/, "$1,$2");
            return temp;
        }

    </script>
</body>
</html>