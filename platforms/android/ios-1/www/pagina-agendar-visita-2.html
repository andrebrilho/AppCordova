<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Crefisa</title>



    <link rel="stylesheet" href="webfiles/css/temaAgendar.css" media="all" type="text/css" />

    <link href="css/jqueryui.css" rel="stylesheet" />
    <link href="styles/loadmask.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/jquery.js"></script>
    <script type="text/javascript" src="scripts/jqueryui.js"></script>
    <script src="scripts/storage-help.js"></script>
    <script src="scripts/util/Util.js"></script>
    <script src="scripts/angular.min.js" type="text/javascript"></script>
    <script src="scripts/jquery.loadmask.js"></script>

    <script type="text/javascript" language="javascript" src="webfiles/plugins/tether/dist/js/tether.min.js" charset="UTF-8"></script>
    <script type="text/javascript" language="javascript" src="webfiles/js/bootstrap.min.js" charset="UTF-8"></script>
    <script type="text/javascript" language="javascript" src="webfiles/js/custom.js" charset="UTF-8"></script>
    <script src="scripts/jqueryuiv12.js"></script>

</head>
<body>

    <nav class="app-nav" style="display: none;">
        <div class="breadcrumb-nav">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12">
                        <a href="javascript:void(0);" title="Voltar" class="app-nav-collapse icone pull-xs-left"><img src="webfiles/images/icones/close.svg" /></a>
                        <div class="text-xs-center">Menu</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="msg-container nome-cliente">

        </div>

        <div id="dvMenu"></div>
    </nav>

    <section class="app-container">

        <div class="breadcrumb-nav">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12">
                        <a href="javascript:void(0);" title="Menu" class="icone app-nav-collapse"><img src="webfiles/images/bars.svg" /></a>
                        <div class="text-xs-center">Agendar visita</div>
                    </div>
                </div>
            </div>
        </div>

        <section class="section central-relacionamento">

            <div class="bg-branco full-height p-t-2 h-100" id="content">

                <div class="walkthrough-full mini">
                    <div class="container">
                        <ul>
                            <li class="actived">
                                <span>1</span>
                            </li>
                            <li class="active">
                                <span>2</span>
                            </li>
                            <li class="">
                                <span>3</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="text-xs-center">
                    <p class="font-medium m-b-3" style="font-size:18px">Há sempre uma Crefisa perto de você</p>
                    <p class="font-heavy" style="font-size:16px; margin-top:30px"><b>Local de visita</b></p>
                </div>

                <div class="container">

                    <form class="form-group form-comum">
                        <div class="row">
                            <div class="col-xs-4 m-b-1 grupo-input">
                                <label style="font-size:22px"><b>UF:</b></label>
                                <select id="cboUf" class="form-control">
                                    <option value="">Selecione</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AM">AM</option>
                                    <option value="AP">AP</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MG">MG</option>
                                    <option value="MS">MS</option>
                                    <option value="MT">MT</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="PR">PR</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SE">SE</option>
                                    <option value="SP">SP</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>

                            <div class="col-xs-8 m-b-1 grupo-input">
                                <label style="font-size:22px"><b>Cidade:</b></label>
                                <select id="cboCidade" disabled class="form-control"></select>
                            </div>
                            <div class="col-xs-12 m-b-1 grupo-input">
                                <label style="font-size:22px"><b>Selecione um ponto de atendimento:</b></label>
                                <select id="cboPonto" disabled class="form-control"></select>
                            </div>
                            <div class="col-xs-12">
                                <div class="text-xs-center p-y-1">
                                    <p class="font-heavy" style="font-size:16px; margin-top:10px"><b>Escolha uma data</b></p>
                                </div>
                            </div>
                            <div class="col-xs-8 m-b-1 grupo-input">
                                <label style="font-size:22px"><b>Selecionar o dia:</b></label>
                                <input type="hidden" class="form-control" id="datepicker">
                                <div id="dateFake" class="form-control" style="height:40px;" onclick="$('#datepicker').datepicker('show');">
                                    <span></span>
                                    <img src="webfiles/images/icones/calendario.svg" onclick="$('#datepicker').datepicker('show');" style="position:absolute;right:25px;top:35px;height:25px" />
                                </div>
                            </div>
                            <div class="col-xs-4 m-b-1 grupo-input">
                                <label style="font-size:22px"><b>Turno:</b></label>
                                <select id="cboTurno" class="form-control">
                                    <option value="">Selecione</option>
                                    <option value="Manha">Manhã</option>
                                    <option value="Tarde">Tarde</option>
                                </select>
                            </div>
                            <div class="col-xs-12 m-t-1">
                                <a href="#" title="Continuar" onclick="EfetuarAgendamento();" class="btn btn-cor-primaria center-block m-t-2" style="font-size:18px;font-weight:bold">Agendar</a>
                            </div>
                        </div>
                    </form>

                </div>
                <section class="barra-acesso">
                    <div class="container">
                        <div class="texto">
                            <p class="nome m-h-20 fsize-1 text-xs-center m-b-0"></p>

                        </div>
                    </div>
                </section>
            </div>

        </section>

    </section>

    <!-- TODO: Modal Falta Pouco -->
    <div class="modal-aviso modal modal-simples modal-vertical fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="faltaPoucoLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="faltaPoucoLabel">Atenção</h4>
                </div>
                <div class="modal-body">
                    <p class="results"> </p>
                    <a href="#" title="Entendi" onclick="$('.modal-aviso').modal('hide')" class="btn btn-cor-primaria m-t-2">Entendi</a>
                </div>
            </div>
        </div>
    </div>


</body>
</html>
<script type="text/javascript">

    InicioNome();

    window.onload = CarregarRodape();


    $(document).ready(function () {

        $("#datepicker").datepicker({
            dateFormat: 'dd/mm/yy',
            dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
            dayNamesMin: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S', 'D'],
            dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
            monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            monthNamesShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            nextText: 'Próximo',
            prevText: 'Anterior',
            changeMonth: true,
            changeYear: true,
            minDate: 1,
            onSelect: function () {
                $("#dateFake span").html($("#datepicker").val());
            }
        });
        $("#datepicker").datepicker("option", "dateFormat", "dd/mm/yy");


        $('#cboUf').on('change', function (e) {
            var optionSelected = $("option:selected", this);
            var valueSelected = this.value;


            document.getElementById("cboPonto").setAttribute("disabled", "disabled");
            $('#cboPonto').html("");

            var u = new Util();
            var sh1 = new StorageHelp();
            var str = "<option value=''>Selecione</option>";
            if (valueSelected == "") {
                document.getElementById("cboCidade").setAttribute("disabled", "disabled");
                $('#cboCidade').html(str);
                str = "";
                return;
            }
            $('#content').loadmask("");

            var dadosUser = sh1.Login_Get();

            dadosUser = JSON.parse(dadosUser);

            jQuery.support.cors = true;
            var request = $.ajax({
                url: u.GetUrlApi() + 'Agendamento/RetornarCidades'
                    , method: 'POST'
                    , crossDomain: true
                    , timeout: u.GetRequestTimeout()
                    , data:
                        { Uf: valueSelected }
            });

            request.done(
                    function (result) {


                        $('#content').unloadmask();
                        document.getElementById("cboCidade").removeAttribute("disabled");
                        $(JSON.parse(result)).each(function () {

                            str += '<option value=' + this.nomeCidade + '>' + this.nomeCidade + '</option>';
                        })
                        $('#cboCidade').html(str);

                        str = "";
                    });
            request.fail(
                function (result) {
                    $('#content').unloadmask();
                    if (result.status == 400) {
                        //BAD REQUEST
                        $('.modal-aviso').modal('show');
                        $('.results').html("Erro não especificado!");
                        //navigator.notification.alert('Erro não especificado!', function () { }, 'Atenção', 'OK');
                    }
                    else if (result.status == 404) {
                        //NOT FOUND
                        $('.modal-aviso').modal('show');
                        $('.results').html("Servidor não encontrado!");
                        //navigator.notification.alert('Servidor não encontrado!', function () { }, 'Atenção', 'OK');
                    }
                    else if (result.status == 408 || result.statusText.toLowerCase() == "timeout") {
                        //TIMEOUT
                        $('.modal-aviso').modal('show');
                        $('.results').html("Tempo de requisição expirou!");
                        //navigator.notification.alert('Tempo de requisição expirou!', function () { }, 'Atenção', 'OK');
                    }
                    else {
                        $('.modal-aviso').modal('show');
                        $('.results').html("Ocorreu um erro não identificado na requisição!");
                        //navigator.notification.alert('Ocorreu um erro não identificado na requisição!', function () { }, 'Atenção', 'OK');
                    }
                }
                );

        });

        $('#cboCidade').on('change', function (e) {
            var optionSelected = $("option:selected", this);
            var valueSelected = this.value;
            var uf = $("#cboUf option:selected").text();

            var u = new Util();
            var sh1 = new StorageHelp();
            var str = "<option value=''>Selecione</option>";

            if (valueSelected == "") {
                document.getElementById("cboPonto").setAttribute("disabled", "disabled");
                $('#cboPonto').html(str);
                str = "";
                return;
            }

            $('#content').loadmask("");

            var dadosUser = sh1.Login_Get();

            dadosUser = JSON.parse(dadosUser);

            jQuery.support.cors = true;
            var request = $.ajax({
                url: u.GetUrlApi() + 'Agendamento/RetornarLojas'
                    , method: 'POST'
                    , crossDomain: true
                    , timeout: u.GetRequestTimeout()
                    , data:
                        {
                            Uf: uf,
                            Cidade: optionSelected[0].text
                        }
            });

            request.done(
                    function (result) {


                        $('#content').unloadmask();
                        document.getElementById("cboPonto").removeAttribute("disabled");
                        $(JSON.parse(result)).each(function () {

                            str += '<option value=' + this.costcenter + '>' + this.bairro + '  - ' + this.rua + ',' + this.numero + '(' + this.estado + ')' + '</option>';
                        })
                        $('#cboPonto').html(str);

                        str = "";
                    });
            request.fail(
                                  function (result) {
                                      $('#content').unloadmask();
                                      if (result.status == 400) {
                                          //BAD REQUEST
                                          $('.modal-aviso').modal('show');
                                          $('.results').html("Erro não especificado!");
                                          //navigator.notification.alert('Erro não especificado!', function () { }, 'Atenção', 'OK');
                                      }
                                      else if (result.status == 404) {
                                          //NOT FOUND
                                          $('.modal-aviso').modal('show');
                                          $('.results').html("Servidor não encontrado!");
                                          //navigator.notification.alert('Servidor não encontrado!', function () { }, 'Atenção', 'OK');
                                      }
                                      else if (result.status == 408 || result.statusText.toLowerCase() == "timeout") {
                                          //TIMEOUT
                                          $('.modal-aviso').modal('show');
                                          $('.results').html("Tempo de requisição expirou!");
                                          //navigator.notification.alert('Tempo de requisição expirou!', function () { }, 'Atenção', 'OK');
                                      }
                                      else {
                                          $('.modal-aviso').modal('show');
                                          $('.results').html("Ocorreu um erro não identificado na requisição!");
                                          //navigator.notification.alert('Ocorreu um erro não identificado na requisição!', function () { }, 'Atenção', 'OK');
                                      }
                                  }
                );

        });
    });



    function EfetuarAgendamento() {

        var u = new Util();
        var sh1 = new StorageHelp();

        var dadosPessoais = JSON.parse(sh1.DadosPessoaisAgendamento_Get());

        var uf = $("#cboUf option:selected").val();
        var cidade = $("#cboCidade option:selected").val();
        var ponto = $("#cboPonto option:selected").val();
        var turno = $("#cboTurno option:selected").text();
        var data = $("#datepicker").val();

        if (uf == "" || cidade == "" || ponto == "" || turno == "Selecione" || data == "") {
            $('.modal-aviso').modal('show');
            $('.results').html("Todos os campos são obrigatórios");
            //navigator.notification.alert('Todos os campos são obrigatórios', function () { }, 'Atenção', 'OK');
            return false;
        }

        var data_1 = new Date(Date.parse($("#datepicker").datepicker("getDate")));
        var data_2 = new Date();
        if (data_1 < data_2) {

            $('.modal-aviso').modal('show');
            $('.results').html("Data do agendamento não pode ser menor que a data atual");
            //navigator.notification.alert('Data do agendamento não pode ser menor que a data atual', function () { }, 'Atenção', 'OK');
            return false;
        }

        if (data_1.getDay() == 0) {
            $('.modal-aviso').modal('show');
            $('.results').html("Não efetuamos agendamentos aos domingos. Nosso horario de atendimento é de segunda à Sexta, das 9h às 18h. Sábado das 9h às 13h.");

            //navigator.notification.alert('Não efetuamos agendamentos aos domingos. Nosso horario de atendimento é de segunda à Sexta, das 9h às 18h. Sábado das 9h às 13h.");', function () { }, 'Atenção', 'OK');
            return false;
        }

        $('#content').loadmask("");

        jQuery.support.cors = true;
        var request = $.ajax({
            url: u.GetUrlApi() + 'Agendamento/EfetuarAgendamento'
                , method: 'POST'
                , crossDomain: true
                , timeout: u.GetRequestTimeout()
                , data:
                    {
                        City: cidade,
                        CostCenter: ponto,
                        CustomerName: dadosPessoais.NomeCompleto,
                        Email: dadosPessoais.Email,
                        Hour: turno,
                        Profile: dadosPessoais.Perfil,
                        SchedulingDat: data,
                        State: uf,
                        TaxId: dadosPessoais.CPF,
                        Telephone: ""

                    }
        });

        request.done(
                function (result) {


                    $('#content').unloadmask();
                    window.localStorage.removeItem("DADOS_PESSOAIS_AGENDAMENTO");
                    if (result != "") {
                        window.location = "pagina-agendar-visita-3.html";
                    } else {
                        $('.modal-aviso').modal('show');
                        $('.results').html("Ocorreu um problema no agendamento da sua visita entre em contato com a central de relacionamento");
                        //navigator.notification.alert('Ocorreu um problema no agendamento da sua visita entre em contato com a central de relacionamento', function () { }, 'Atenção', 'OK');
                    }

                });
        request.fail(
                function (result) {
                    $('#content').unloadmask();
                    if (result.status == 400) {
                        //BAD REQUEST
                        $('.modal-aviso').modal('show');
                        $('.results').html("Erro não especificado!");
                        //navigator.notification.alert('Erro não especificado!', function () { }, 'Atenção', 'OK');
                    }
                    else if (result.status == 404) {
                        //NOT FOUND
                        $('.modal-aviso').modal('show');
                        $('.results').html("Servidor não encontrado!");
                        //navigator.notification.alert('Servidor não encontrado!', function () { }, 'Atenção', 'OK');
                    }
                    else if (result.status == 408 || result.statusText.toLowerCase() == "timeout") {
                        //TIMEOUT
                        $('.modal-aviso').modal('show');
                        $('.results').html("Tempo de requisição expirou!");
                        //navigator.notification.alert('Tempo de requisição expirou!', function () { }, 'Atenção', 'OK');
                    }
                    else {
                        $('.modal-aviso').modal('show');
                        $('.results').html("Ocorreu um erro não identificado na requisição!");
                        //navigator.notification.alert('Ocorreu um erro não identificado na requisição!', function () { }, 'Atenção', 'OK');
                    }
                }
            );




    }
</script>